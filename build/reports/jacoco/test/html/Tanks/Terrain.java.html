<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Terrain.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tanks_scaffold (1)</a> &gt; <a href="index.source.html" class="el_package">Tanks</a> &gt; <span class="el_source">Terrain.java</span></div><h1>Terrain.java</h1><pre class="source lang-java linenums">package Tanks;

import org.json.JSONObject;
import processing.core.PApplet;
import processing.core.PImage;
import java.util.*;

import static java.lang.Math.abs;
/* NOTE THAT:
 * x is the areaa under X
 * X is the terrain height
 * A,B,C,D,E: denotes the player
 * 0,1,2,3,.. denotes machine player
 * @ denotes empty space (the sky that aboves the X)
 * */

public class Terrain {
    private PApplet sketch;
    public GameState gameState;
    private HashSet&lt;Explosion&gt; destruction;
<span class="fc" id="L21">    float[] averageHeight = new float[896]; //each pixel</span>
    public ArrayList&lt;Tank&gt; tanksList;
    //Max 28 trees;
    private boolean[] hasDead;
    private boolean[] hasUpdated;
    ArrayList&lt;Explosion&gt; handleDraw;
    Level currentLevel;
<span class="fc" id="L28">    public Terrain (GameState gameState, JSONObject layoutSetting, float[] averageHeight, ArrayList&lt;Tank&gt; tanksList, Level level){</span>
<span class="fc" id="L29">        this.gameState = gameState;</span>
<span class="fc" id="L30">        this.averageHeight = averageHeight;</span>
<span class="fc" id="L31">        this.tanksList = tanksList;</span>
<span class="fc" id="L32">        this.destruction = new HashSet&lt;&gt;();</span>
<span class="fc" id="L33">        currentLevel = level;</span>
<span class="fc" id="L34">        hasDead = new boolean[this.tanksList.size()];</span>
<span class="fc" id="L35">        hasUpdated = new boolean[this.tanksList.size()];</span>
<span class="fc" id="L36">        Arrays.fill(hasDead, false);</span>
<span class="fc" id="L37">        handleDraw = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L38">    }</span>
    public float[] getAverageHeight(){
<span class="fc" id="L40">        return this.averageHeight;</span>
    }
    public double calculateImpactRange(float x, float y, float centerX, float centerY){
<span class="fc" id="L43">        return (Math.pow(centerX-x,2) + Math.pow(centerY-y,2));</span>
    }

    public void updateTank(HashSet&lt;Explosion&gt; destruction){
<span class="fc bfc" id="L47" title="All 2 branches covered.">        for(Explosion explosion: destruction) {</span>
<span class="fc" id="L48">            int centerX = (int) explosion.getX();</span>
<span class="fc" id="L49">            float centerY = explosion.getY();</span>
<span class="fc" id="L50">            float radius = explosion.getRadius();</span>
<span class="fc" id="L51">            Tank tankCausation = explosion.getTank();</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">            for (int i = 0; i &lt; this.tanksList.size(); i++) {</span>
<span class="fc" id="L53">                Tank tank = this.tanksList.get(i);</span>
<span class="fc" id="L54">                int tankX = tank.getX();</span>
<span class="fc" id="L55">                float tankY = tank.getY();</span>
<span class="fc" id="L56">                double distance = calculateImpactRange(tankX, tankY, centerX, centerY);</span>
<span class="fc" id="L57">                double trueDistance = Math.sqrt(distance);</span>
<span class="fc" id="L58">                double damage = 0;</span>
<span class="fc bfc" id="L59" title="All 4 branches covered.">                if(trueDistance &lt;= radius &amp;&amp; tank.getHealth() &gt; 0){</span>
<span class="fc" id="L60">                    damage = (1 - trueDistance/radius)*60;</span>
<span class="fc" id="L61">                    tank.setHealth(tank.getHealth() - (int) damage);</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">                    if(tank != tankCausation) {</span>
<span class="fc" id="L63">                        tankCausation.setPoint(tankCausation.getPoint() + (int) damage);</span>
                    }
                }
            }
<span class="fc" id="L67">        }</span>
<span class="fc" id="L68">    }</span>
    public void setDestruction(HashSet&lt;Explosion&gt; destruction){
<span class="nc" id="L70">        this.destruction = destruction;</span>
<span class="nc" id="L71">    }</span>
    public void updateTerrain(HashSet&lt;Explosion&gt; destruction){
<span class="fc bfc" id="L73" title="All 2 branches covered.">        for(Explosion e: destruction){</span>
<span class="fc" id="L74">            int centerX = (int) e.getX();</span>
<span class="fc" id="L75">            float centerY = e.getY();</span>
<span class="fc" id="L76">            float radius = e.getRadius();</span>
<span class="fc" id="L77">            int start = Math.max(0, (int)  (centerX - radius));</span>
<span class="fc" id="L78">            int end = Math.min(864, (int) (centerX + radius));</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            for(int i = start; i &lt; end; i++) {</span>
<span class="fc" id="L80">                float distance = (float) Math.sqrt(Math.pow(radius, 2) - Math.pow(centerX - i, 2));</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                if (this.averageHeight[i] &lt; centerY - distance){</span>
<span class="fc" id="L82">                    this.averageHeight[i] += 2 * distance;</span>
                }
<span class="pc bpc" id="L84" title="1 of 4 branches missed.">                else if (this.averageHeight[i] &gt;= centerY - distance &amp;&amp; this.averageHeight[i] &lt;= centerY + distance) {</span>
<span class="fc" id="L85">                    this.averageHeight[i] = centerY + distance;</span>
                }

            }
<span class="fc" id="L89">        }</span>
<span class="fc" id="L90">    }</span>

    public void drawExplosion(){
<span class="fc" id="L93">        Iterator&lt;Explosion&gt; it = handleDraw.iterator();</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        while(it.hasNext()){</span>
<span class="fc" id="L95">            Explosion nextExplosion = it.next();</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">            if(!nextExplosion.isHasDoneExplode()){</span>
<span class="fc" id="L97">                nextExplosion.drawExplosion();</span>
            }
            else{
<span class="fc" id="L100">                it.remove();</span>
            }
<span class="fc" id="L102">        }</span>
<span class="fc" id="L103">    }</span>
    public void updateTankHeight(PApplet sketch){
<span class="fc" id="L105">        ArrayList&lt;Explosion&gt; destruct = new ArrayList&lt;&gt;(this.destruction);</span>
<span class="fc" id="L106">        Explosion explosion = null;</span>
<span class="fc" id="L107">        Tank tankCause = null;</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if(!destruct.isEmpty()){</span>
<span class="fc" id="L109">            explosion  = destruct.get(0);</span>
<span class="fc" id="L110">            tankCause = explosion.getTank();</span>
        }
<span class="fc bfc" id="L112" title="All 2 branches covered.">        for(Tank tank: this.tanksList){</span>
<span class="fc" id="L113">            int xTank = tank.getX();</span>
<span class="fc" id="L114">            float newY = this.averageHeight[xTank];</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            if(newY != tank.getY()) {</span>
<span class="fc" id="L116">                int damage = (int) (newY - tank.getY());</span>
<span class="pc bpc" id="L117" title="1 of 6 branches missed.">                if((tank.getParachuteCount() == 0 || tank.getY() &gt;= 640) &amp;&amp; !hasUpdated[this.tanksList.indexOf(tank)]) {</span>
<span class="fc" id="L118">                    hasUpdated[this.tanksList.indexOf(tank)] = true;</span>
<span class="pc bpc" id="L119" title="4 of 10 branches missed.">                    if (tankCause != null &amp;&amp; tankCause != tank &amp;&amp; (tank.getHealth() &gt; 0) &amp;&amp; tank.getX() &lt;= explosion.getX() + explosion.getRadius() &amp;&amp; tank.getX() &gt;= explosion.getX() - explosion.getRadius()){</span>
<span class="fc" id="L120">                        tankCause.setPoint(tankCause.getPoint() + damage);</span>
                    }
<span class="fc" id="L122">                    tank.setHealth(tank.getHealth() - damage);</span>
                }
<span class="fc" id="L124">                tank.reduceY(1.0f / sketch.frameRate, newY);</span>
<span class="fc" id="L125">            }</span>
            else{
<span class="fc" id="L127">                hasUpdated[this.tanksList.indexOf(tank)] = false;</span>
            }
<span class="fc" id="L129">        }</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        for(Tank tank: this.tanksList){</span>
<span class="fc" id="L131">            tank.setAverageHeight(this.averageHeight);</span>
<span class="fc" id="L132">        }</span>
<span class="fc" id="L133">        this.destruction.clear();</span>
<span class="fc" id="L134">    }</span>
    public void setHeight(int index, float newValue){
<span class="nc" id="L136">        this.averageHeight[index] = newValue;</span>
<span class="nc" id="L137">    }</span>
    public void setTanks(ArrayList&lt;Tank&gt; tanks){
<span class="fc" id="L139">        this.tanksList = tanks;</span>
<span class="fc" id="L140">    }</span>
    public void setState(GameState newState){
<span class="fc" id="L142">        this.gameState = newState;</span>
<span class="fc" id="L143">    }</span>
    public ArrayList&lt;Tank&gt; getTankList(){
<span class="fc" id="L145">        return this.tanksList;</span>
    }
    public ArrayList&lt;Explosion&gt; getDestruction(){
<span class="nc" id="L148">        return new ArrayList&lt;&gt;(this.destruction);</span>
    }
    public void setTerrain(int index, float newY){
<span class="nc" id="L151">        this.averageHeight[index] = newY;</span>
<span class="nc" id="L152">    }</span>
    public void renderTerrain(PApplet sketch, ArrayList&lt;float[]&gt; treesList, boolean[] treesPosition, ArrayList&lt;PImage&gt; assets, int[] colorList){
<span class="fc" id="L154">            sketch.image(assets.get(0), 0, 0);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if(hasUpdated.length != this.tanksList.size()){</span>
<span class="fc" id="L156">                hasUpdated = new boolean[this.tanksList.size()];</span>
<span class="fc" id="L157">                Arrays.fill(hasUpdated, false);</span>
            }
            //DRAW THE MAP
<span class="fc" id="L160">            drawExplosion();</span>
<span class="fc" id="L161">            updateTerrain(this.destruction);</span>
<span class="fc" id="L162">            updateTank(this.destruction);</span>
<span class="fc" id="L163">            this.updateTankHeight(sketch);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">            for (int i = 0; i &lt; this.averageHeight.length; i++) {</span>
<span class="fc" id="L165">                sketch.stroke(colorList[0], colorList[1], colorList[2]);</span>
<span class="fc" id="L166">                sketch.rect(i, this.averageHeight[i], 1, 640 - this.averageHeight[i]);</span>
            }
<span class="fc bfc" id="L168" title="All 2 branches covered.">            for (int i = 0; i &lt; treesList.size(); i++) {</span>
<span class="fc" id="L169">                int x = (int) treesList.get(i)[0]; // toa do x</span>
<span class="fc" id="L170">                float randomNum = treesList.get(i)[2];</span>
<span class="fc" id="L171">                int imageHeight = assets.get(1).height;</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">                if (treesPosition[x]) { //which denotes there's a tree there</span>
<span class="fc" id="L173">                    int xPos = (int) (x*32 + randomNum);</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">                    if(xPos &gt;= 896){</span>
<span class="nc" id="L175">                        xPos = 895;</span>
                    }
<span class="fc bfc" id="L177" title="All 2 branches covered.">                    else if(xPos &lt; 0){</span>
<span class="fc" id="L178">                        xPos = 0;</span>
                    }
<span class="fc" id="L180">                    float yPos = (int) Math.min(895, this.averageHeight[Math.min(895, xPos + 16)] - imageHeight);</span>
<span class="fc" id="L181">                    sketch.image(assets.get(1), xPos, yPos);</span>
                }
            }
<span class="fc" id="L184">            this.gameState.drawScoreBoard();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">            if(this.currentLevel.isGameOver()){</span>
<span class="fc" id="L186">                return;</span>
            }

<span class="fc bfc" id="L189" title="All 2 branches covered.">            for (int i = 0; i &lt; this.tanksList.size(); i++){</span>
<span class="fc" id="L190">                Tank tankToDraw = this.tanksList.get(i);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">                if(hasDead.length == this.tanksList.size()) {</span>
<span class="pc bpc" id="L192" title="1 of 8 branches missed.">                    if (!hasDead[i] &amp;&amp; (tankToDraw.getHealth() &lt;= 0 || tankToDraw.getY() &gt;= 640) &amp;&amp; this.averageHeight[tankToDraw.getX()] &lt;= tankToDraw.getY()) {</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">                        if(tankToDraw.getHealth() &lt;= 0) {</span>
<span class="fc" id="L194">                            handleDraw.add(new Explosion(tankToDraw, sketch, tankToDraw.getX(), tankToDraw.getY(), 15, null));</span>
                        }
<span class="nc bnc" id="L196" title="All 2 branches missed.">                        else if(tankToDraw.getY() &gt;= 640){</span>
<span class="nc" id="L197">                            handleDraw.add(new Explosion(tankToDraw, sketch, tankToDraw.getX(), tankToDraw.getY(), 30, null));</span>

                        }
<span class="fc" id="L200">                        hasDead[i] = true;</span>
<span class="fc" id="L201">                        tankToDraw.setHealth(0);</span>
                    }
                }
                else{
<span class="fc" id="L205">                    hasDead = new boolean[this.tanksList.size()];</span>

                }
<span class="fc bfc" id="L208" title="All 2 branches covered.">                if (!tankToDraw.getTankExplosionList().isEmpty()) {</span>
<span class="fc" id="L209">                    Explosion firstExplosion = tankToDraw.getTankExplosionList().get(0);</span>
<span class="fc" id="L210">                    this.destruction.addAll(tankToDraw.getTankExplosionList());</span>
<span class="fc" id="L211">                    handleDraw.addAll(tankToDraw.getTankExplosionList());</span>
<span class="fc" id="L212">                    tankToDraw.getTankExplosionList().remove(firstExplosion);</span>
                }
<span class="fc" id="L214">                tankToDraw.drawTank(sketch);</span>
<span class="fc" id="L215">                tankToDraw.endTurn();</span>
            }
<span class="fc" id="L217">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>